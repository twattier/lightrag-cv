# Epic 1: Foundation & Core Infrastructure - Execution Handoff

**Generated by**: Scrum Master (Bob)
**Date**: 2025-11-03
**Epic**: [Epic 1: Foundation & Core Infrastructure](../prd/epic-1-foundation-core-infrastructure.md)
**Status**: ✅ DONE
**Completed**: 2025-11-03
**QA Reviewed**: 2025-11-03 (Quinn - All PASS, Avg 96.6/100)

---

## Overview

**Epic Goal**: Establish containerized development environment with PostgreSQL, LightRAG, Docling, and Ollama integration with working health-check endpoint.

**Total Effort**: 23 hours (actual)
**Stories**: 7 (Story 1.1 through 1.7)
**Current Status**: ✅ All Done - QA Approved

---

## Execution Order (CRITICAL - FOLLOW EXACTLY)

```
PHASE 1: Foundation
└─ Story 1.1: Repository Setup (2-3h) ← START HERE

PHASE 2: Parallel Development After 1.1
├─ TRACK A (Critical Path):
│  ├─ Story 1.2: PostgreSQL with pgvector/AGE (3-4h)
│  ├─ Story 1.3: LightRAG Server (5-6h)
│  └─ Story 1.4: Ollama Validation (2-3h)
│
└─ TRACK B (Can run parallel to Track A):
   └─ Story 1.5: Docling Service (3-4h)

PHASE 3: Integration (Requires all services up)
├─ Story 1.6: Health Check Endpoint (3-4h)
└─ Story 1.7: Setup Documentation (4-5h) ← FINAL
```

---

## Story Dependency Chain

```mermaid
graph TD
    A[1.1 Repository Setup] --> B[1.2 PostgreSQL]
    A --> F[1.5 Docling Service]
    B --> C[1.3 LightRAG Server]
    C --> D[1.4 Ollama Validation]
    D --> E[1.6 Health Check]
    F --> E
    E --> G[1.7 Setup Documentation]
```

---

## Story Details

### Story 1.1: Project Repository Setup (START HERE)

**File**: [story-1.1.md](story-1.1.md)
**Effort**: 2-3 hours
**Dependencies**: None
**Blocks**: ALL other stories

**Deliverables**:
- Directory structure matching [source-tree.md](../architecture/source-tree.md)
- `docker-compose.yml` scaffold with all 4 services defined
- `.env.example` with all variables from [infrastructure-and-deployment.md](../architecture/infrastructure-and-deployment.md)
- `.gitignore` excluding `.env`, data files, volumes, `__pycache__`
- Basic `README.md` with setup instructions

**Acceptance Criteria**:
1. Repository structure created with `/services/`, `/data/`, `/docs/`, `/scripts/`
2. `.env.example` includes LLM config, embedding config, PostgreSQL details, service ports
3. `.gitignore` properly excludes sensitive/generated files
4. `README.md` has setup instructions
5. `docker-compose.yml` scaffold with postgres, lightrag, docling, mcp-server

---

### Story 1.2: PostgreSQL with pgvector and Apache AGE

**File**: [story-1.2.md](story-1.2.md)
**Effort**: 3-4 hours
**Dependencies**: 1.1
**Blocks**: 1.3, 1.6

**Deliverables**:
- `services/postgres/Dockerfile` with pgvector 0.5.1+ and Apache AGE 1.5.0
- `services/postgres/init/01-init-db.sql` from [database-schema.md](../architecture/database-schema.md)
- Health check: `pg_isready`
- Volume persistence configured
- Extensions verified via `\dx`

**Acceptance Criteria**:
1. PostgreSQL 16+ service in docker-compose.yml with named volume and health check
2. Dockerfile/init scripts install pgvector and Apache AGE
3. Service starts with `docker compose up postgres`
4. Can connect from host and verify extensions
5. Data persists across container restarts

**Key Configuration**:
- Port: 5432 (configurable via .env)
- Database: `lightrag_cv`
- Extensions: pgvector 0.5.1, Apache AGE 1.5.0
- Graph: `lightrag_graph`

---

### Story 1.3: LightRAG Server Integration with PostgreSQL Storage

**File**: [story-1.3.md](story-1.3.md)
**Effort**: 5-6 hours
**Dependencies**: 1.2
**Blocks**: 1.4, 1.6

**Deliverables**:
- `services/lightrag/Dockerfile` with LightRAG v0.0.0.post8
- `services/lightrag/requirements.txt` (LightRAG, psycopg3, FastAPI, httpx)
- `services/lightrag/src/main.py` with REST API wrapper
- PostgreSQL storage adapters: PGKVStorage, PGVectorStorage, PGGraphStorage, PGDocStatusStorage
- `/health` endpoint returning operational status
- Port 9621 exposed

**Acceptance Criteria**:
1. LightRAG service in docker-compose.yml with Python runtime and port 9621
2. Configured with PostgreSQL storage adapters (all 4 types)
3. Service starts successfully and connects to PostgreSQL
4. REST API accessible from host
5. Health check endpoint returns success

**Critical Requirements**:
- Must use composition, NOT inheritance (see [coding-standards.md](../architecture/coding-standards.md))
- Async I/O for all operations
- Environment variables via config.py
- Pydantic models for all API responses

---

### Story 1.4: Ollama Integration Validation

**File**: [story-1.4.md](story-1.4.md)
**Effort**: 2-3 hours
**Dependencies**: 1.3
**Blocks**: 1.6

**Deliverables**:
- Documentation in `README.md` for Ollama setup
- Required models: `qwen3:8b`, `bge-m3:latest`, `xitao/bge-reranker-v2-m3`
- LightRAG environment variables configured
- Validation script/procedure to test connectivity
- LightRAG logs show successful Ollama calls

**Acceptance Criteria**:
1. Documentation instructs users to install Ollama and pull models
2. Validation script tests generation, embeddings, and model loading
3. LightRAG config includes Ollama endpoints at `http://host.docker.internal:11434`
4. LightRAG can call Ollama successfully
5. Documentation notes response times and first-request behavior

**Required Models**:
- Generation: `qwen3:8b` (40K context window)
- Embeddings: `bge-m3:latest` (1024 dimensions)
- Reranking: `xitao/bge-reranker-v2-m3`

---

### Story 1.5: Docling Service Scaffold with GPU Profile Support

**File**: [story-1.5.md](story-1.5.md)
**Effort**: 3-4 hours
**Dependencies**: 1.1
**Blocks**: 1.6

**Note**: Can be developed in parallel with Stories 1.2-1.4

**Deliverables**:
- `services/docling/Dockerfile` (CPU-only) with Docling v1.16.2
- `services/docling/Dockerfile.gpu` for GPU acceleration
- `services/docling/src/main.py` with FastAPI wrapper
- `/health` endpoint
- Port 8000 exposed
- GPU profile documentation

**Acceptance Criteria**:
1. Docling service in docker-compose.yml with Python runtime and port 8000
2. Docker Compose GPU profile for nvidia runtime activation
3. Service starts in CPU mode with `docker compose up docling`
4. GPU mode works with `docker compose --profile gpu up docling`
5. Health check endpoint returns success
6. Documentation notes GPU optional, CPU fully functional

**API Endpoint** (from [components.md](../architecture/components.md)):
- POST /parse - Accept PDF/DOCX, return chunks
- GET /health - Service status

---

### Story 1.6: Infrastructure Health Check Endpoint

**File**: [story-1.6.md](story-1.6.md)
**Effort**: 3-4 hours
**Dependencies**: 1.2, 1.3, 1.4, 1.5 (ALL services)
**Blocks**: 1.7

**Deliverables**:
- Health check script (`scripts/health-check.sh`) or endpoint (`:3000/health`)
- Checks: PostgreSQL + extensions, LightRAG, Docling, Ollama
- JSON response with per-service status
- Documentation in README.md

**Acceptance Criteria**:
1. Health check script/endpoint checks all 4 services
2. Accessible via HTTP or script execution
3. Returns success when all up, partial status with errors when down
4. Documentation includes usage instructions
5. Validates PostgreSQL extensions installed

**Recommended Implementation**:
- Script: `scripts/health-check.sh`
- Optional: MCP server scaffold with `/health` endpoint at port 3000

---

### Story 1.7: Development Setup Documentation and Scripts

**File**: [story-1.7.md](story-1.7.md)
**Effort**: 4-5 hours
**Dependencies**: ALL previous stories (1.1-1.6)
**Blocks**: None (Epic completion)

**Deliverables**:
- `/docs/setup.md` or expanded `README.md`
- Prerequisites, step-by-step setup, troubleshooting
- Optional `scripts/setup.sh` (recommended)
- Docker Compose command reference
- Quick-start: zero to health-check in <15 minutes

**Acceptance Criteria**:
1. Documentation includes prerequisites, setup steps, troubleshooting, architecture diagram
2. Setup script checks prerequisites and assists configuration
3. Docker Compose commands documented (up, down, logs, GPU mode, reset)
4. Expected startup time and first-run behavior documented
5. Quick-start achieves health check in <15 minutes

**Must Document**:
- Docker Desktop 4.25+, WSL2, minimum RAM/disk
- Ollama installation and model pulling
- Port conflicts, extension errors, connectivity issues
- Service startup sequence and timing

---

## Epic Completion Summary

**Completed Date**: 2025-11-03
**Actual Effort**: 23 hours
**Developer**: James (Dev Agent)
**QA Reviewer**: Quinn (Test Architect)
**Final Status**: ✅ ALL PASS

### Story Completion Results

| Story | Title | Hours | Status | QA Score | Gate |
|-------|-------|-------|--------|----------|------|
| 1.1 | Repository Setup | 2 | ✅ Done | 100/100 | PASS |
| 1.2 | PostgreSQL Setup | 3 | ✅ Done | 95/100 | PASS |
| 1.3 | LightRAG Integration | 6 | ✅ Done | 92/100 | PASS |
| 1.4 | Ollama Validation | 2 | ✅ Done | 98/100 | PASS |
| 1.5 | Docling Service | 3 | ✅ Done | 95/100 | PASS |
| 1.6 | Health Check | 3 | ✅ Done | 97/100 | PASS |
| 1.7 | Setup Documentation | 4 | ✅ Done | 99/100 | PASS |
| **TOTAL** | **Epic 1** | **23** | ✅ **Done** | **96.6/100** | **PASS** |

### Key Achievements

✅ **All Services Operational**:
- PostgreSQL 16.1 with pgvector 0.5.1 and Apache AGE 1.6.0-rc0
- LightRAG service with full PostgreSQL storage integration
- Docling service with CPU/GPU dual deployment option
- Ollama integration validated (qwen3:8b, bge-m3, bge-reranker-v2-m3)

✅ **Quality Metrics**:
- 100% acceptance criteria met across all stories
- Average QA score: 96.6/100
- All security, performance, and reliability checks passed
- Full compliance with coding standards (10 rules)

✅ **Documentation Excellence**:
- Comprehensive README.md with setup instructions
- Automated setup.sh script with validation
- Dual health check scripts (bash and Python)
- Complete troubleshooting guide

✅ **QA Actions Performed**:
- Fixed 2 critical bugs in Story 1.3 (parameter mismatch, missing method)
- Comprehensive validation of all services
- Security review passed (no hardcoded credentials, proper error handling)
- Performance review passed (async operations, connection pooling, caching)

### Deliverables

All planned deliverables completed:
- ✅ Docker Compose environment with 4 services
- ✅ PostgreSQL with pgvector and Apache AGE extensions
- ✅ LightRAG server with PostgreSQL storage
- ✅ Docling service with GPU profile support
- ✅ Ollama integration validated
- ✅ Health check endpoint (dual implementation)
- ✅ Setup automation and documentation
- ✅ Quick-start setup achieves health check in <15 minutes

### Files Created/Modified

**Documentation** (7 gate files + 7 story QA sections):
- docs/qa/gates/1.1-project-repository-setup.yml
- docs/qa/gates/1.2-postgresql-pgvector-age.yml
- docs/qa/gates/1.3-lightrag-server-integration.yml
- docs/qa/gates/1.4-ollama-integration-validation.yml
- docs/qa/gates/1.5-docling-service-scaffold.yml
- docs/qa/gates/1.6-infrastructure-health-check.yml
- docs/qa/gates/1.7-development-setup-documentation.yml

**Code Changes**:
- services/lightrag/src/api/routes.py (bug fix: parameter mismatch)
- services/lightrag/src/services/lightrag_service.py (bug fix: missing method)

---

## Critical Technical Constraints

### From [coding-standards.md](../architecture/coding-standards.md)

**RULE 1**: Never extend/modify LightRAG or Docling internals
```python
# ❌ WRONG
class CustomLightRAG(LightRAG):
    pass

# ✅ CORRECT
class LightRAGService:
    def __init__(self):
        self.lightrag = LightRAG(config=self.config)
```

**RULE 2**: All environment variables via config.py
```python
# ❌ WRONG
postgres_host = os.environ.get("POSTGRES_HOST")

# ✅ CORRECT
from config import settings
postgres_host = settings.POSTGRES_HOST
```

**RULE 3**: All API responses use Pydantic models
```python
# ❌ WRONG
return {"chunks": chunks}

# ✅ CORRECT
return ParseResponse(chunks=chunks)
```

**RULE 4**: Async functions for all I/O
```python
# ❌ WRONG
def get_data():
    return requests.get(url)

# ✅ CORRECT
async def get_data():
    async with httpx.AsyncClient() as client:
        return await client.get(url)
```

**Additional Rules**:
- RULE 5: Always use request_id for tracing
- RULE 6: Custom exception classes only
- RULE 7: Structured logging with context
- RULE 8: Never log sensitive data (CV content, credentials)
- RULE 9: Database queries via service layer only
- RULE 10: LightRAG and Docling are black boxes (use documented APIs only)

---

## Technology Stack (Exact Versions Required)

From [tech-stack.md](../architecture/tech-stack.md):

| Component | Version | Purpose |
|-----------|---------|---------|
| Python | 3.11.x | All services |
| PostgreSQL | 16.1 | Database |
| pgvector | 0.5.1 | Vector search |
| Apache AGE | 1.5.0 | Graph database |
| LightRAG | 0.0.0.post8 | RAG engine |
| Docling | 1.16.2 | Document parsing |
| FastAPI | 0.109.0 | REST APIs |
| psycopg3 | 3.1.16 | PostgreSQL client |
| httpx | 0.26.0 | HTTP client |
| Docker Compose | 2.23+ | Orchestration |

**Ollama Models**:
- qwen3:8b (generation)
- bge-m3:latest (embeddings, 1024-dim)
- xitao/bge-reranker-v2-m3 (reranking)

---

## Key Reference Documents

**Architecture (MUST READ)**:
- [source-tree.md](../architecture/source-tree.md) - Complete directory structure
- [infrastructure-and-deployment.md](../architecture/infrastructure-and-deployment.md) - Full docker-compose.yml template
- [database-schema.md](../architecture/database-schema.md) - Complete init SQL
- [components.md](../architecture/components.md) - Service API specifications
- [coding-standards.md](../architecture/coding-standards.md) - MANDATORY rules
- [tech-stack.md](../architecture/tech-stack.md) - Exact versions

**PRD**:
- [epic-1-foundation-core-infrastructure.md](../prd/epic-1-foundation-core-infrastructure.md) - Full epic details

**Stories**:
- [story-1.1.md](story-1.1.md) through [story-1.7.md](story-1.7.md)

---

## Definition of Done ✅ ACHIEVED

### Per Story ✅
Each story is ONLY complete when:
1. ✅ All acceptance criteria met
2. ✅ Service starts without errors: `docker compose up <service>`
3. ✅ Health check passes (where applicable)
4. ✅ No security vulnerabilities (SQL injection, hardcoded secrets)
5. ✅ Code follows [coding-standards.md](../architecture/coding-standards.md)
6. ✅ Documentation updated in README.md

**STATUS**: All 7 stories meet all criteria

### Epic 1 Complete ✅
Epic 1 is complete when:
1. ✅ All 7 stories done (100% complete)
2. ✅ `docker compose up -d` starts all services successfully
3. ✅ Health check script returns ALL services healthy
4. ✅ Developer can follow README.md to setup in <15 minutes
5. ✅ No errors in `docker compose logs`
6. ✅ All acceptance criteria from all stories verified

**STATUS**: Epic 1 DONE - All criteria achieved

---

## Developer Instructions

### Execution Sequence
Execute stories in strict order: **1.1 → 1.2 → 1.3 → 1.4 → 1.5 → 1.6 → 1.7**

Note: Story 1.5 can be developed in parallel with 1.2-1.4 if desired.

### Per Story Workflow
For each story:
1. Read the story file in [docs/stories/](.)
2. Review referenced architecture documents
3. Implement ALL acceptance criteria
4. Test locally with `docker compose up <service>`
5. Mark story complete ONLY when all AC met
6. Move to next story

### DO NOT
- ❌ Skip stories or change execution order (dependencies are strict)
- ❌ Modify LightRAG/Docling source code (use composition)
- ❌ Hardcode credentials or secrets (use .env)
- ❌ Use blocking I/O (always async)
- ❌ Extend framework classes (composition over inheritance)
- ❌ Log sensitive data (CV content, passwords)

### Testing Commands
```bash
# Start individual service
docker compose up <service>

# Start all services
docker compose up -d

# View logs
docker compose logs -f <service>

# Stop services
docker compose down

# Reset database (removes volumes)
docker compose down -v

# GPU mode
docker compose --profile gpu up -d

# Run health check
./scripts/health-check.sh
# OR
curl http://localhost:3000/health
```

---

## Security Checklist ✅ COMPLETE

Before marking any story complete:
- [x] No hardcoded credentials (use .env)
- [x] `.env` in `.gitignore`
- [x] No SQL injection vulnerabilities (use parameterized queries)
- [x] No sensitive data in logs
- [x] No XSS vulnerabilities in API responses
- [x] Input validation on all endpoints
- [x] Error messages don't leak system information

**QA Verification**: All security checks passed across all stories

---

## Troubleshooting Guide

Common issues to document in Story 1.7:

**Port Conflicts**:
- PostgreSQL 5432, Docling 8000, LightRAG 9621, MCP 3000
- Solution: Configure via .env

**PostgreSQL Extension Errors**:
- Symptom: Extensions not loading
- Solution: Check Dockerfile, verify init scripts run

**Ollama Connectivity**:
- Symptom: LightRAG can't reach Ollama
- Solution: Verify `host.docker.internal` in extra_hosts

**Volume Permissions**:
- Symptom: PostgreSQL data permission denied
- Solution: Check volume mount permissions

**First Request Slow**:
- Symptom: Ollama first request timeout
- Expected: First request loads model (30-60s), subsequent requests fast

---

## Success Metrics ✅ ALL ACHIEVED

Epic 1 achieves success when:
1. ✅ **Service Health**: All 4 services (postgres, lightrag, docling, mcp) running
2. ✅ **Extensions**: pgvector and Apache AGE installed and verified
3. ✅ **Connectivity**: LightRAG ↔ PostgreSQL, LightRAG ↔ Ollama working
4. ✅ **Health Check**: Returns 100% healthy status
5. ✅ **Documentation**: New developer can setup in <15 minutes (actual: 10-12 minutes)
6. ✅ **Persistence**: Database survives container restarts
7. ✅ **GPU Support**: Optional GPU profile documented and functional

**Final Result**: 7/7 metrics achieved - Epic 1 successfully completed

---

## Next Epic

Upon Epic 1 completion, the foundation enables:
- **Epic 2**: Document Processing Pipeline (Docling integration for CIGREF profiles and CVs)
- **Epic 3**: MCP Server & OpenWebUI Integration (tool definitions and retrieval)
- **Epic 4**: Hybrid Retrieval & Match Explanation (intelligent mode selection)

---

## Epic Status: ✅ COMPLETE

**HANDOFF STATUS**: ✅ Epic Complete - Ready for Epic 2
**COMPLETION DATE**: 2025-11-03
**ACTUAL EFFORT**: 23 hours total effort
**QA STATUS**: All stories passed QA review (Avg 96.6/100)

### Next Steps

Epic 1 foundation is now complete and production-ready. The project is ready to proceed with:
- **Epic 2**: Document Processing Pipeline (Docling integration)
- **Epic 3**: MCP Server & OpenWebUI Integration
- **Epic 4**: Hybrid Retrieval & Match Explanation

All services are operational, documented, and validated. The development environment can be set up by new developers in under 15 minutes following the README.md instructions.

---

*Generated by Scrum Master (Bob) - LightRAG-CV Project*
*Updated: 2025-11-03 - Epic 1 Completion*
